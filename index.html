<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <title>What's the number ?</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>

    <div class="flex">
        <div class="container">
            <div class="text">
                <h2>What's the number</h2>
                <div class="content">
                    <h3>Consignes : </h3>
                    <p>Dessinez un chiffre de 0 à 9 dans le carré ci-dessous</p>
                </div>
                <div class="status"></div>
            </div>
            <div class="drawing">
                <canvas id="canvas"></canvas>
            </div>
            <div class="container-button">
                <button id="reset" onclick="resetCanvas()">Effacer</button>
                <button id="guess">Deviner</button>
            </div>
            <div class="answer">
                <p>Je pense que c'est :</p>
                <p class="result"></p>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext("2d");
        canvas.width = 400;
        canvas.height = 400;
        ctx.lineWidth = 25;
        ctx.lineCap = "round";
        ctx.strokeStyle = "white";

        let drawing = false;

        function startDraw(e) {
            drawing = true;
            draw(e);
        }

        function endDraw() {
            drawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!drawing) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener("mousedown", startDraw);
        canvas.addEventListener("mouseup", endDraw);
        canvas.addEventListener("mousemove", draw);

        function resetCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        let session = null;

       
        async function loadModel() {
            try {
                session = await ort.InferenceSession.create("./model.onnx");
                document.querySelector(".status").textContent = "Modèle chargé ✔";
                 console.log('Model chargé')
            } catch(error) {
                document.querySelector(".status").textContent = "Erreur de chargement";
                console.error("Problème lors du cargement du model :", error);
            }
        }

        function generateImageTensor() {
            const smallCanvas = document.createElement("canvas");
            smallCanvas.width = 28;
            smallCanvas.height = 28;

            const sctx = smallCanvas.getContext("2d");
            sctx.fillStyle = "black";
            sctx.fillRect(0, 0, 28, 28);
            sctx.drawImage(canvas, 0, 0, 28, 28);

            const imgData = sctx.getImageData(0, 0, 28, 28).data;
            const input = new Float32Array(28 * 28);

            for (let i = 0; i < input.length; i++) {
                const r = imgData[i * 4 + 0];
                const g = imgData[i * 4 + 1];
                const b = imgData[i * 4 + 2];

                const grayscale = (r + g + b) / 3 / 255;

                input[i] = grayscale;
            }

            return new ort.Tensor("float32", input, [1, 1, 28, 28]);
        }

        async function guess() {
            if (!session) {
               console.error('Model non chargé')
                return;
            }

            const inputTensor = generateImageTensor();
            const feeds = {};
            feeds[session.inputNames[0]] = inputTensor;
            const output = await session.run(feeds);
            const outputTensor = output[session.outputNames[0]];
            const data = outputTensor.data;

            let max = -Infinity;
            let index = 0;

            data.forEach((value, i) => {
                if (value > max) {
                    max = value;
                    index = i;
                }
            });

            document.querySelector(".result").textContent = index;
            console.log('Prédiction réalisé !')
        }

        document.getElementById("guess").addEventListener("click", guess);

        loadModel();
    </script>


</body>
</html>